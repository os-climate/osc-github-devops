---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: "SBOM (CycloneDX)"
# Python Software Bill of Materials (SBOM) generation

# yamllint disable-line rule:truthy
"on":
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - "pyproject.toml"
      - "*.lock"
      - "requirements*.txt"
      - "Pipfile.lock"
      - ".github/workflows/sbom.yaml"
  schedule:
    # Weekly (Monday 04:15 UTC) â€“ adjust as desired
    - cron: "15 4 * * 1"

permissions:
  contents: read
  actions: read  # For downloading previous SBOM artifacts

jobs:
  sbom:
    name: "Generate CycloneDX SBOM"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: "Harden Runner"
        # yamllint disable-line rule:line-length
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout"
      # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Generate SBOM with Python SBOM Action"
        id: generate-sbom
        # yamllint disable-line rule:line-length
        uses: modeseven-lfreleng-actions/python-sbom-action@initial-update
        with:
          python_version: "3.12"
          include_dev: "false"
          sbom_format: "both"
          sbom_spec_version: "1.5"
          filename_prefix: "sbom-cyclonedx"
          fail_on_error: "true"

      - name: "SBOM Generation Summary"
        shell: bash
        # yamllint disable rule:line-length
        run: |
          {
            echo "## ðŸ“‹ SBOM Generation Results"
            echo "**Dependency Manager:** ${{ steps.generate-sbom.outputs.dependency_manager }}"
            echo "**Components Found:** ${{ steps.generate-sbom.outputs.component_count }}"
            echo "**JSON SBOM:** [sbom-cyclonedx.json](${{ steps.generate-sbom.outputs.sbom_json_path }})"
            echo "**XML SBOM:** [sbom-cyclonedx.xml](${{ steps.generate-sbom.outputs.sbom_xml_path }})"
          } >> "$GITHUB_STEP_SUMMARY"
        # yamllint disable rule:line-length

      - name: "Download Previous SBOM (for diff)"
        if: github.event_name != 'workflow_dispatch'
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: sbom-cyclonedx-previous
          path: previous-sbom/
        continue-on-error: true

      - name: "Generate SBOM Diff Report"
        if: github.event_name != 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail

          if [[ -f "previous-sbom/sbom-cyclonedx.json" ]]; then
            {
              echo "## SBOM Dependency Changes"
              echo ""
            } >> sbom-diff-report.md

            # Simple JSON diff for dependency changes (basic implementation)
            if command -v jq >/dev/null 2>&1; then
              # Extract component names and versions from both SBOMs
              jq -r '.components[]? | "\(.name)@\(.version)"' \
                sbom-cyclonedx.json | sort > current-deps.txt
              jq -r '.components[]? | "\(.name)@\(.version)"' \
                previous-sbom/sbom-cyclonedx.json | sort > previous-deps.txt

              # Find added dependencies
              if added_deps=$(comm -13 previous-deps.txt \
                current-deps.txt); then
                if [[ -n "$added_deps" ]]; then
                  {
                    echo "### âž• Added Dependencies"
                    echo '```'
                    echo "$added_deps"
                    echo '```'
                    echo ""
                  } >> sbom-diff-report.md
                fi
              fi

              # Find removed dependencies
              if removed_deps=$(comm -23 previous-deps.txt \
                current-deps.txt); then
                if [[ -n "$removed_deps" ]]; then
                  {
                    echo "### âž– Removed Dependencies"
                    echo '```'
                    echo "$removed_deps"
                    echo '```'
                    echo ""
                  } >> sbom-diff-report.md
                fi
              fi

              # Count total components
              current_count=$(jq '.components | length' \
                sbom-cyclonedx.json 2>/dev/null || echo "0")
              previous_count=$(jq '.components | length' \
                previous-sbom/sbom-cyclonedx.json 2>/dev/null || echo "0")

              {
                echo "### ðŸ“Š Summary"
                echo "- **Previous SBOM**: $previous_count components"
                echo "- **Current SBOM**: $current_count components"
                echo "- **Net Change**: $((current_count - previous_count)) components"
                echo "- **Tool**:"
                echo "${{ steps.generate-sbom.outputs.dependency_manager }}"
              } >> sbom-diff-report.md

              # Clean up temporary files
              rm -f current-deps.txt previous-deps.txt
            else
              echo "âš ï¸ jq not available for detailed diff analysis" \
                >> sbom-diff-report.md
            fi
          else
            {
              echo "## SBOM Diff Report"
              echo ""
              echo "No previous SBOM found for comparison."
              echo "This may be the first run or artifacts may have expired."
            } >> sbom-diff-report.md
          fi

          # Add diff report to step summary
          if [[ -f sbom-diff-report.md ]]; then
            cat sbom-diff-report.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "Upload SBOM Artifacts"
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom-cyclonedx
          path: |
            sbom-cyclonedx.json
            sbom-cyclonedx.xml
            sbom-diff-report.md
          if-no-files-found: error
          retention-days: 90

      - name: "Upload Previous SBOM (for next run)"
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom-cyclonedx-previous
          path: |
            sbom-cyclonedx.json
            sbom-cyclonedx.xml
          if-no-files-found: error
          retention-days: 30

        # OPTIONAL: Attach to a release when triggered by a tag.
        # Uncomment to enable.
        # - name: "Attach SBOM to Release"
        #   if: startsWith(github.ref, 'refs/tags/')
        #   uses: alexellis/upload-assets@13926a61cdb2cb35f5fdef1c06b8b591523236d3 # 0.4.1
        #   env:
        #     GITHUB_TOKEN: "${{ github.token }}"
        #   with:
        #     asset_paths: '["sbom-cyclonedx.json","sbom-cyclonedx.xml"]'
